<!DOCTYPE html">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<script src="http://gtbcode.lcs.io/js/jquery.js"></script>
	<script src="http://gtbcode.lcs.io/js/bootstrap.js"></script>
	<script src="http://gtbcode.lcs.io/js/jquery.plugin.js"></script>
	<title>sql2doc</title>
	<link rel="stylesheet" href="http://gtbcode.lcs.io/css/bootstrap.min.css" />
	<style> 
	::-webkit-scrollbar{width:10px;height:10px;}
	::-webkit-scrollbar-button:vertical:increment{background-color:transparent;}
	::-webkit-scrollbar-track:enabled{background-color:rgba(113,112,107,0.1);-webkit-border-radius:5px;}
	::-webkit-scrollbar-thumb{height:50px;background-color:rgba(0,0,0,.2);-webkit-border-radius:5px;}
	::-webkit-scrollbar-thumb:hover{background-color:rgba(0,0,0,.4);box-shadow:inset 1px 1px 1px rgba(0,0,0,.25)}
	::-webkit-scrollbar-track:hover {background-color: rgba(0,0,0,.1);box-shadow: inset 1px 1px 0 rgba(0,0,0,.1)}
	::-webkit-scrollbar-button{height:0;width:0}

	.animate{
		-webkit-transition: all .3s ease-in-out;
		   -moz-transition: all .3s ease-in-out;
			-ms-transition: all .3s ease-in-out;
			 -o-transition: all .3s ease-in-out;
				transition: all .3s ease-in-out;
	}

	table th[colspan]{font-weight: bold; line-height: 50px; font-size: 30px; }
	ol{margin: 0 auto;padding: 0;}
	li{padding: 5px 0px 0px 10px;width: 290px;display: inline-block;}
	[table].table-hide table{display:none}
	tr[key=primary] td{background-color:rgb(217, 237, 247);}
	tr[key*=fk] td{background-color:rgb(223, 240, 216);}
	tr.index td{background-color: rgb(247, 217, 221)}
	tr td:first-child{ font-weight: bold; text-align: center; color: gray;}
	.to-top{ opacity: .3; position: fixed; right: 3px; bottom: 10px; zoom: 2.5; }
	.to-top:hover{opacity: 1}
	body.fixed [nav] {opacity:0.01;background: white;height: 100px;overflow-y: scroll;position: fixed;top: 0;border-width:0px 0px 2px;border-bottom-style:solid;border-radius:7px;}
	body.fixed [nav]:hover{opacity:0.8;}
	body.fixed{padding-top: 600px;}
	tr {cursor: pointer;}
	</style>
	<script>
	$(function(){
		var $data = $("textarea");
		var $btn = $("a.btn.sql");
		var $tbody = $("tbody");
		var $table = $("[table]");
		var $nav = $("[nav]");
		
		var tr = "<tr><td html-no ></td><td html-name >字段名</td><td html-type >数据类型</td><td html-null >可空</td><td html-default >默认</td><td html-comment >描述</td></tr>";

		var getComments = function(text){
			var data = {};
			(text.match(/comment\son[^;]+;/gi)||[]).forEach(function(comment) {
				var arr = comment.trim().replace(/^comment\son\s(table|column)/i,'').replace(/\s+/g,' ').split(/\sis\s/i);
				data[arr[0].toUpperCase().trim()] = arr[1].replace(/[';]/g,'');
			});
			console.log(data);
			return data;
		};
		var getIndexs = function(val){
			var indexs = {};
			(val.match(/create\sindex\s\w+\son\s[^\)]+\)/gi)||[]).forEach(function(index){
				var text = index.split(/\son\s/i).pop();
				text = text.trim().replace(/[\(\)]/g,'').replace(/\s/,'.');
				indexs[text.toUpperCase()] = true;
			});
			console.log(indexs);
			return indexs;
		};
		$table.remove();
		$btn.click(function(){
			$("[table]").remove();
			var c = 1 ;
			var val = $data.val();
			var comments = getComments(val);
			var getComment = function(table,column){
				var key = table + (column ? '.'+column:'');
				return comments[key.toUpperCase()] || '';
			};

			$.each(val.match(/CREATE\s+TABLE[^;]+\n\);?\n/ig).sort(),function(i,table){
				var $_table = $table.clone();
				var $_tbody = $_table.find("tbody");
				var keys = {};

				var rows = table.split("\n");
				var tableName = rows.shift().trim().split(' ').pop();
				
				//if( !/(^SYS_|^BI_)/.test(tableName) )return;
				
				var getKeys = function( tableName ){
					var text = val.match( new RegExp("ALTER TABLE "+tableName+"[^;]+;","gi")) || [];
					var key = {};
					var colReg = /\(`([^`\)]+(`\,`)?)+`\)/;
					$.each(text , function(i,row){
						var k = row.match(/PRIMARY\sKEY\s\(\w+\)/gi);

						if( k ){
							key.primary = k[0].match(/\(\w+\)/)[0].replace(/[\(\)]/g,'');
						}
						k = row.match(/FOREIGN\sKEY\s\(\w+\)/gi);
						if( k ){
							key["fk_"+i] = {
								col:k[0].match(/\(\w+\)/)[0].replace(/[\(\)]/g,''),
								table:row.match(/REFERENCES\s[^\)]+\)/i)[0].replace(/REFERENCES|\(\w+\)|\s/ig,'')
							};
						}
					});
					return key;

				};
				$_table.setHtml({title:tableName + " " + getComment(tableName)});
				$_table.find("[html-title]").attr("id",tableName);
				$nav.append("<li>"+(c++)+" <a href='#"+tableName+"' >" + tableName + " " + getComment(tableName) + "</a></li>");
				$_table.find("[button]").html('<i class="icon-white icon-chevron-up"></i> '+tableName).attr("id",tableName);
				$_table.find("table").attr("name",tableName);

				keys = getKeys(tableName);

				$.each(rows,function(i,row){
					row = row.trim();

					var _ = row.trim().replace(/\s+/,' ').split(" ");
					var data = {};
					if(!_[1])return;
					if(/constraint/i.test(_[0]))return;
					data.no = i;
					data.name = _[0].match(/\w+/)[0];
					data.type = _[1];//.replace(/\,/g,"");
					data.null = row.match(/NOT NULL/i)?"N":"Y";
					data.default = (row.match(/DEFAULT\s[^\s]+[\s,]/i)||[""])[0].match(/\s.+/);
					data.default = (data.default||[""])[0].trim().replace(/(\'|,$)/g,"") || "";
					data.comment = getComment(tableName,data.name);
					$_tbody.append($(tr).setHtml(data).attr("name",data.name));
				});
				$.each(keys,function(k,key){
					var name = key.col || key;
					var $tr = $_table.find("tr[name='" + name + "']").attr('key',k);
					if ( key.table ){
						var $td = $tr.find("[html-name]");
						$td.html($("<a>").html($td.html()).prop("href","#"+key.table));
					}
				});
				$("body").append($_table);
			});

			$.each(getIndexs(val),function(key){
				var arr = key.split('.');
				arr[1].split(',').forEach(function(name){
					$('table[name='+arr[0]+'] tr[name='+name.trim()+']').addClass('index');
				});
			});

			$("[button]").click(function(){
				$(this).parent().toggleClass("table-hide");
				$(this).find("i").toggleClass("icon-chevron-down");
			});

		});


		$(":file").change(function(){
			var reader = new FileReader();
			reader.onload = function(){
				$data.val(reader.result);
				$btn.click();
			};
			reader.readAsText(this.files[0]);
		});

		$("div[drag]").on("drop",function(e){
			$.log(e);
			return false;
		})[0].addEventListener( "drop", function(e) {
			buttone.stopPropagation();
			e.preventDefault();
			$.log(e);
		});
	});
	</script>
	<script>
	$(function(){
		$("[button]").click(function(){
			$(this).parent().toggleClass("table-hide");
			$(this).find("i").toggleClass("icon-chevron-down");
		});
		var $body = $("body");
		$(window).scroll(function(e){
			var _class = $body.attr("class")||"";
			if(document.body.scrollTop >600){
				_class.indexOf("fixed") == -1 && $body.addClass("fixed");
			}else{ 
				_class.indexOf("fixed") != -1 && $body.removeClass("fixed"); 
			}
		});
	});
	</script>
	<script type="text/javascript">
		$(document).on("click",".btn.haha",function(){
			var $this = $(this);
			$this.prevAll().remove();
			$('script').remove();
			$this.hide();
			var $html = $('html').clone();
			$html.find('.btn.haha').remove();
			$this.prop('href',URL.createObjectURL( new Blob([$html[0].outerHTML]) ));
			setTimeout(function(){$this.remove();},100);
		});
	</script>
</head>
<body style="">
	<textarea focused placeholder='输入sql.....(需要jquery jquery.plugin bootstrap)' style=" height: 50px; width: 48%;"></textarea>
	<div drag  style="width:48%;height:50px;float:right;background-color:gray"></div>
	<br>
	<input type=file /><br>
	<a class="btn sql" >translate</a>
	<br>
	<br>
	<a class='btn btn-default haha' download="sql.html" >haha</a>
	<ol nav >
	</ol>
	<div table class >
<!--	
<a href=javascript: button class="btn btn-danger btn-mini" style=" margin-bottom: 3px; " >ZS</a>
-->

	<h1 html-title colspan=6  ></h1>
	<table class='table table-bordered table-condensed table-hover'  style="font-family: 宋体, serif;">
		<thead>
			<tr><th style="width: 50px;">序号</th><th style="width: 150px;">字段名</th><th style="width: 150px;">数据类型</th><th style="width: 50px;">可空</th><th style="width: 150px;">默认</th><th>描述</th></tr>
		</thead>
		<tbody>
			
		</tbody>
	</table>
	<br>
	</div>
	<a href="#">
		<i class="icon-plane to-top animate"></i>
	</a>
</body>
<script type="text/javascript">

</script>
</html>
